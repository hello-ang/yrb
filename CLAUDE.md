# Claude Skills（yrb 项目）

## 你的角色

你是该仓库的实现助手，所有开发动作以仓库内的开发文档为唯一标准：以 [READE.md](file:///e:/开发/cn/READE.md) 为准；不得擅自新增/删减功能、不得改变命令逻辑、不得引入额外第三方依赖、不得新增额外目录结构。

## 项目目标（不可偏离）

- 包名固定：`yrb`
- 核心命令：`yrb pip ...` / `yrb conda ...`（前缀式，兼容原生所有参数）
- 兼容：Python 3.8+
- 体积与规模：安装包 ≤ 500KB；核心代码 ≤ 1000 行；无冗余代码
- 跨平台：Windows 10+ / macOS 12+ / Ubuntu 20.04+

## 硬约束（必须遵守）

- 依赖白名单：仅允许 `requests>=2.25.0`、`click>=8.0.0`、`platformdirs>=3.0.0`
- 不修改用户原生环境：镜像配置只能通过“临时环境变量”注入，执行完不残留任何系统配置变更
- 国内镜像优先：仅面向国内镜像测速与切换，不接入国外源
- 参数 100% 兼容：`yrb pip`/`yrb conda` 必须透传并兼容各自原生参数
- 目录结构固定：仅 `yrb/core`、`yrb/adapter`、`yrb/cli`（不得新增额外目录层级）
- 生产代码必须干净：无调试打印、无测试代码、无无用导入、无冗余分支

## 交付物与清洁性策略

- 开发阶段允许存在 `tests/` 用于验证，但发布前必须彻底删除整个 `tests/` 目录及所有测试残留
- 最终项目仅保留生产必要文件：`yrb/`、`pyproject.toml`、`LICENSE`、`CHANGELOG.md`、`README.md`、开发手册等（以开发文档的交付物清单为准）

## 实施顺序（严格按依赖推进）

1. 基础搭建：目录结构 + `pyproject.toml` + CLI 入口点
2. 核心层：镜像池 → 测速 → 缓存 → 断点续传 → 核心联调
3. 适配层：pip 适配 → conda 适配 → 适配联调
4. 交互层：CLI 命令解析 → 异常处理 → 跨平台兼容 → 全量测试
5. 清洁打包发布：删除测试残留 → 打包优化 → 文档最终同步 → 发布准备

## 关键实现要点（必须对齐文档）

### 镜像测速

- 使用 HTTP HEAD 测速，超时 3 秒
- 过滤不可用镜像并选择最优镜像；无可用镜像需抛出连接类错误

### pip 适配

- 仅通过临时环境变量设置 `PIP_INDEX_URL`/`PIP_TRUSTED_HOST`
- 执行方式：调用 `pip._internal.main` 执行原生命令，不重写 pip 下载逻辑
- 参数透传：不得丢失或“自作主张”改写任何 pip 原生参数

### conda 适配

- 仅通过临时环境变量设置 `CONDA_CHANNELS` 等通道参数
- 执行方式：使用 `subprocess` 执行 conda 命令并返回结果
- 参数透传：不得丢失或“自作主张”改写任何 conda 原生参数

### 缓存

- 缓存路径必须通过 `platformdirs` 获取，禁止硬编码路径
- 缓存记录使用 JSON 存储，查询性能目标 ≤ 100ms

### 断点续传

- 通过 Range 请求实现；文件存在时检查已下载大小并续传
- 下载完成需要进行完整性校验（hash 比对）

## 开发工作方式（高质量产出）

- 变更前先定位对应章节约束，写代码只实现文档要求的最小闭环
- 一次只聚焦一个模块/一个目标；完成后立即自检冗余并清理
- 若文档存在歧义：给出 2–3 个可行方案及利弊，等待人工确认后再定稿

## 验收清单（提交前自检）

- 功能：所有命令可用，前缀命令与辅助命令齐全，参数兼容无缺口
- 性能：测速 ≤ 3 秒；大包续传成功；缓存查询 ≤ 100ms
- 体验：`yrb` 可全局调用；安装包 ≤ 500KB；Python 3.8+ 可用
- 代码：核心 ≤ 1000 行；无冗余；无测试残留；仅白名单依赖
- 文档：与最终生产代码 100% 一致
